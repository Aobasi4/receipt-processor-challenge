import uuid
import json
import math
import datetime
from openapi_spec_validator import validate_spec
from openapi_spec_validator.readers import read_from_filename
from openapi_schema_validator import validate

spec_dict, base_uri = read_from_filename('../api.yml')

validate_spec(spec_dict)

file = open('file.json')

schema = json.load(file)
file.close()

database = {}

# Takes in a JSON receipt (see example in the example directory) and returns a JSON object with an ID generated by your code.
def process_receipt(prototype):
    receipt = prototype.json
    receipt['points'] = calcuate_total_points(receipt)

    id = str(uuid.uuid4)

    database['X'] = receipt

    return {'id':id}

def calcuate_total_points(prototype):
    points = 0 
    points += character_points(prototype)
    points += round_dollar_amount_points(prototype)
    points += multiple_points(prototype)
    points += item_points(prototype)
    points += description_points(prototype)
    points += day_points(prototype)
    points += time_points(prototype)
    return points

def character_points(prototype):
    # return len['retail'] => must be alphanumeric
    points = sum(c.isalpha() for c in prototype['retailer'])
    return points

def round_dollar_amount_points(prototype):
    if prototype['total'].is_integer():
        return 50 
    else:
        return 0
    
def multiple_points(prototype):
    if prototype['total'] % .25 == 0: 
        return 25 
    else:
        return 0
    
def item_points(prototype):
    return (5 * math.floor(len(prototype['items'])))
    
def description_points(prototype): 
    total = 0
    for item in prototype['items']:

        description = item['shortDescription']
        price = item['price']

        if len(description) % 3 == 0:
            total += math.ceil(price* .2)
    
    return total

def day_points(prototype):
    date = prototype['purchaseDate']
    day = int(date.strftime("%d"))

    if day % 2 != 0:
        return 6 
    else : 
        return 0
    
def time_points(prototype): 
    #retrun 10 points if the time of purchase is after 2 and before 4

    date = prototype['purchaseDate']
    hour = int(date.strftime("%H"))
    minute = int(date.strftime("%M"))

    if hour == 2 and minute < 1:
        return 0
    if hour > 2 and hour < 4:
       return 10 
    
    return 0